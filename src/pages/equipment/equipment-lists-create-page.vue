<template>
  <div class="min-h-screen bg-accent">
    <!-- Header —Å Breadcrumbs -->
    <div class="bg-white border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 py-4">
        <BreadcrumbsV2 
          :items="breadcrumbs" 
          variant="minimal" 
          size="sm"
          @item-click="handleBreadcrumbClick"
          @navigate="handleBreadcrumbNavigate"
        />
        
        <div class="flex justify-between items-center mt-4">
          <div>
            <h1 class="text-2xl font-bold text-primary">
              {{ isEditMode ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è' : '–°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è' }}
            </h1>
            <p class="text-sm text-secondary mt-1">
              {{ isEditMode 
                ? '–ò–∑–º–µ–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–ø–∏—Å–∫–µ –∏ —Å–æ—Å—Ç–∞–≤–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è' 
                : '–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã' 
              }}
            </p>
          </div>
          
          <ButtonV2 
            variant="ghost"
            size="md"
            @click="navigateBack"
          >
            <template #icon>
              <span class="text-sm">‚Üê</span>
            </template>
            –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫–∞–º
          </ButtonV2>
        </div>
      </div>
    </div>

    <!-- Main Content –≤ Bento Grid -->
    <div class="max-w-7xl mx-auto px-4 py-6">
      <div class="grid gap-4 grid-cols-1 md:grid-cols-[2fr_1fr] contain-layout">
        
        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (Mobile: –ø–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞, Desktop: –ª–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞) -->
        <div class="space-y-4 md:space-y-6">
          
          <!-- 1. –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
          <ListBasicInfoForm
            :form-data="formData"
            :form-errors="formErrors"
            :auto-generated-name="autoGeneratedName"
            :auto-generated-description="autoGeneratedDescription"
            :is-edit-mode="isEditMode"
            @update:form-data="updateFormData"
            @update:form-errors="updateFormErrors"
            @type-change="handleTypeChange"
          />

          <!-- 2. –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è security —Å–ø–∏—Å–∫–æ–≤) -->
          <ListLinkedDataForm
            :form-data="formData"
            :form-errors="formErrors"
            :event-options="eventOptions"
            :mount-point-options="mountPointOptions"
            :events-loading="eventsLoading"
            :mount-points-loading="mountPointsLoading"
            :events-error="eventsError"
            :mount-points-error="mountPointsError"
            :conflict-info="conflictInfo"
            @update:form-data="updateFormData"
            @update:form-errors="updateFormErrors"
            @event-change="handleEventChange"
            @mount-point-change="handleMountPointChange"
          />

          <!-- 3. –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
          <EquipmentSearchFilters
            :search-query="searchQuery"
            :selected-category="selectedCategory"
            :selected-subcategory="selectedSubcategory"
            :search-suggestions="searchSuggestions"
            :search-loading="searchLoading"
            :equipment-categories="equipmentCategories"
            @search="handleSearch"
            @search-select="handleSearchSelect"
            @search-clear="handleSearchClear"
            @category-change="handleCategoryChange"
            @subcategory-change="handleSubcategoryChange"
            @clear-filters="handleClearFilters"
          />

          <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞—Ö -->
          <div v-if="formData.type === 'security' && formData.event_id && hasConflicts" 
               class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
            
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π —Ä–∞—Å–∫—Ä—ã—Ç–∏—è -->
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="flex-shrink-0">
                  <IconV2 name="alert-triangle" size="md" color="warning" />
                </div>
                <div>
                  <h4 class="font-semibold text-amber-800">
                    –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                  </h4>
                  <p class="text-sm text-amber-700">
                    –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ <strong>{{ conflictedEquipmentCount }}</strong> –µ–¥–∏–Ω–∏—Ü –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                  </p>
                </div>
              </div>
              
              <!-- –ö–Ω–æ–ø–∫–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è/—Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è -->
              <button
                @click="showConflictDetails = !showConflictDetails"
                class="flex items-center gap-1 px-3 py-1 text-xs font-medium text-amber-700 bg-amber-100 hover:bg-amber-200 rounded-md transition-colors duration-200"
              >
                <span>{{ showConflictDetails ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å' }} –¥–µ—Ç–∞–ª–∏</span>
                <IconV2 
                  :name="showConflictDetails ? 'chevron-up' : 'chevron-down'" 
                  size="xs" 
                  color="warning" 
                />
              </button>
            </div>

            <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–∞—è) -->
            <div 
              v-if="showConflictDetails"
              class="mt-4 pt-4 border-t border-amber-200 transition-all duration-300 ease-in-out"
            >
              <p class="text-sm text-amber-700 mb-3">
                –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é:
              </p>
              <div class="space-y-2">
                <div v-for="stat in conflictStats" :key="stat.listName" 
                     class="flex items-center justify-between text-sm bg-amber-100/50 rounded-md p-2">
                  <span class="text-amber-700">
                    ‚Ä¢ –°–ø–∏—Å–æ–∫ "{{ stat.listName }}" ({{ stat.mountPointName }})
                  </span>
                  <span class="font-medium text-amber-800">{{ stat.equipmentCount }} –µ–¥–∏–Ω–∏—Ü</span>
                </div>
              </div>
              <p class="text-xs text-amber-600 mt-3 p-2 bg-amber-100/30 rounded-md">
                üí° <strong>–°–ø—Ä–∞–≤–∫–∞:</strong> –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–∏–∂–µ –∏ –æ—Ç–º–µ—á–µ–Ω–æ –∏–∫–æ–Ω–∫–æ–π –∑–∞–º–∫–∞.
              </p>
            </div>
          </div>

          <!-- 4. –¢–∞–±–ª–∏—Ü–∞ —Å –≤—ã–±–æ—Ä–æ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è -->
          <EquipmentTableWithSelection
            :data="equipments"
            :loading="equipmentLoading || conflictsLoading"
            :error="equipmentError || conflictsError"
            :current-page="currentPage"
            :total-pages="totalPages"
            :items-per-page="itemsPerPage"
            :total="totalEquipmentCount"
            :sort-by="sortBy"
            :sort-order="sortOrder"
            :selected-ids="selectedEquipmentIds"
            :conflict-info="conflictInfo"
            @sort="handleSort"
            @page-change="handlePageChange"
            @items-per-page-change="handleItemsPerPageChange"
            @selection-change="handleSelectionChange"
          />

        </div>

        <!-- –î–µ–π—Å—Ç–≤–∏—è –∏ –ø—Ä–µ–≤—å—é (Mobile: —Å–Ω–∏–∑—É, Desktop: –ø—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞) -->
        <div class="order-first md:order-last">
          <div class="space-y-4 md:space-y-6">
            
            <!-- –ü–∞–Ω–µ–ª—å —Å–æ–∑–¥–∞–Ω–∏—è -->
            <ListCreationActions
              :form-data="formData"
              :can-create-list="canCreateList"
              :progress-percentage="progressPercentage"
              :create-loading="createLoading"
              :auto-generated-name="autoGeneratedName"
              :selected-equipment-count="selectedEquipmentIds.length"
              :event-name="getEventName(formData.event_id)"
              :is-mobile="isMobile"
              :is-edit-mode="isEditMode"
              @create-list="handleCreateList"
              @reset-form="handleResetForm"
              @cancel="navigateBack"
            />

            <!-- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è -->
            <div class="md:sticky md:top-6 md:z-10">
              <SelectedEquipmentPreview
                :selected-equipment="selectedEquipmentData"
                @remove="handleRemoveEquipment"
                @clear-all="handleClearSelection"
                @export-list="handleExportList"
              />
            </div>

          </div>
        </div>

      </div>
    </div>

    <!-- Notification System -->
    <NotificationV2 ref="notificationSystem" position="top-right" />
  </div>
</template>

<script setup>
/**
 * EquipmentListsCreatePage - EPR System (Refactored)
 * 
 * –†–µ—Ñ–∞–∫—Ç–æ—Ä–µ–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ composable –¥–ª—è –ª–æ–≥–∏–∫–∏
 */

import { ref, computed, onMounted, onBeforeUnmount, watch } from 'vue'
import { useRouter } from 'vue-router'
import { useBreakpoints } from '@vueuse/core'
import { debounce } from 'lodash-es'

// UI Kit v2
import { 
  BreadcrumbsV2, 
  ButtonV2, 
  IconV2,
  NotificationV2 
} from '@/shared/ui-v2'

// –ù–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
import ListBasicInfoForm from './components/list-creation/ListBasicInfoForm.vue'
import ListLinkedDataForm from './components/list-creation/ListLinkedDataForm.vue'
import ListCreationActions from './components/list-creation/ListCreationActions.vue'
import { useListCreation } from './components/list-creation/useListCreation.js'

// –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
import EquipmentSearchFilters from './components/EquipmentSearchFilters.vue'
import EquipmentTableWithSelection from '@/features/equipment/components/EquipmentTableWithSelection.vue'
import SelectedEquipmentPreview from '@/features/equipment/components/SelectedEquipmentPreview.vue'

// Stores –∏ API
import { useEquipmentStore } from '@/features/equipment'
import { useAuthStore } from '@/app/store/auth-store'
import { EQUIPMENT_CATEGORIES } from '@/features/equipment/constants/categories.js'
import { createEquipmentList, updateEquipmentList } from '@/features/equipment/api/equipment-lists-api.js'
import { useEquipmentListsData } from '@/features/equipment/composables/useEquipmentListsData'
import { useEquipmentReservation } from './composables/useEquipmentReservation.js'

const router = useRouter()
const equipmentStore = useEquipmentStore()
const authStore = useAuthStore()

// ===== –ü–ê–†–ê–ú–ï–¢–†–´ –†–û–£–¢–ê =====
const props = defineProps({
  id: {
    type: String,
    default: null
  }
})

// ===== –ö–û–ú–ü–û–ó–ò–¶–ò–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê =====
const {
  formData,
  formErrors,
  createLoading,
  loadingListData,
  isEditMode,
  listId,
  autoGeneratedName,
  autoGeneratedDescription,
  canCreateList,
  progressPercentage,
  validateForm,
  updateFormData,
  updateFormErrors,
  updateSelectedEquipment,
  updateLinkedData,
  handleTypeChange: handleTypeChangeLogic,
  resetForm,
  loadListForEdit
} = useListCreation(props.id) // –ü–µ—Ä–µ–¥–∞–µ–º ID –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

// ===== –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ =====
const breakpoints = useBreakpoints({
  sm: 640,
  md: 768,
  lg: 1024,
  xl: 1280,
})

const isMobile = breakpoints.smaller('md')

// ===== BREADCRUMBS =====
const breadcrumbs = [
  { label: '–ì–ª–∞–≤–Ω–∞—è', href: '/', icon: 'home' },
  { 
    label: '–ú–æ–¥—É–ª—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è', 
    href: '/equipment',
    submenu: [
      { label: 'üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º', href: '/equipment/items', icon: 'settings' },
      { label: 'üìã –°–ø–∏—Å–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è', href: '/equipment/lists', icon: 'list' },
      { label: '‚ûï –°–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫', href: '/equipment/lists/create', icon: 'plus' }
    ]
  },
  { label: '–°–ø–∏—Å–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è', href: '/equipment/lists' },
  { label: isEditMode ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞' : '–°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞', disabled: true }
]

// ===== –í–´–ë–û–† –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø =====
const selectedEquipmentIds = ref([])

// ===== UI –°–û–°–¢–û–Ø–ù–ò–ï =====
const showConflictDetails = ref(false)

// ===== –†–ï–ó–ï–†–í–ò–†–û–í–ê–ù–ò–ï –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø =====
const {
  conflictInfo,
  conflictsLoading,
  conflictsError,
  hasConflicts,
  conflictedEquipmentCount,
  conflictStats,
  setEvent,
  loadConflicts,
  isEquipmentConflicted,
  getEquipmentConflictInfo,
  canAddEquipment,
  getConflictMessage,
  clearConflicts
} = useEquipmentReservation()

// –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–∫–∞–∑–∞ –¥–µ—Ç–∞–ª–µ–π –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
watch(hasConflicts, (newValue) => {
  if (!newValue) {
    showConflictDetails.value = false
  }
})

// ===== –ü–û–ò–°–ö –ò –§–ò–õ–¨–¢–†–´ =====
const searchQuery = ref('')
const selectedCategory = ref('')
const selectedSubcategory = ref('')
const searchSuggestions = ref([])
const searchLoading = ref(false)

// ===== –î–ê–ù–ù–´–ï –¢–ê–ë–õ–ò–¶–´ =====
const equipmentLoading = computed(() => equipmentStore.loading)
const equipmentError = computed(() => equipmentStore.error)
const equipments = computed(() => equipmentStore.equipments)
const currentPage = computed(() => equipmentStore.currentPage)
const totalPages = computed(() => equipmentStore.totalPages)
const itemsPerPage = computed(() => equipmentStore.itemsPerPage)
const totalEquipmentCount = computed(() => equipmentStore.total)
const sortBy = computed(() => equipmentStore.sortBy)
const sortOrder = computed(() => equipmentStore.sortOrder)

// ===== –î–ê–ù–ù–´–ï –°–ü–ò–°–ö–û–í =====
const {
  eventOptions,
  mountPointOptions,
  eventsLoading,
  mountPointsLoading,
  eventsError,
  mountPointsError,
  loadMountPoints,
  clearMountPoints,
  getEventName,
  getMountPointName,
  initialize: initializeListsData
} = useEquipmentListsData()

const notificationSystem = ref(null)
const equipmentCategories = EQUIPMENT_CATEGORIES

// ===== –û–¢–î–ï–õ–¨–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï –î–õ–Ø –í–´–ë–†–ê–ù–ù–û–ì–û –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø =====
const selectedEquipmentCache = ref(new Map()) // Map<id, equipmentData>

// ===== COMPUTED =====
const selectedEquipmentData = computed(() => {
  // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤ –∫—ç—à–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
  const fromCache = selectedEquipmentIds.value
    .map(id => selectedEquipmentCache.value.get(id))
    .filter(Boolean)
  
  // –ü–æ—Ç–æ–º –∏—â–µ–º –≤ –æ—Å–Ω–æ–≤–Ω–æ–º store (–¥–ª—è –Ω–æ–≤—ã—Ö –¥–æ–±–∞–≤–ª–µ–Ω–∏–π)
  const fromStore = equipments.value.filter(equipment => 
    selectedEquipmentIds.value.includes(equipment.id) && 
    !selectedEquipmentCache.value.has(equipment.id)
  )
  
  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –≤ store —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∫—ç—à
  fromStore.forEach(equipment => {
    selectedEquipmentCache.value.set(equipment.id, equipment)
  })
  
  return [...fromCache, ...fromStore]
})

// ===== –ú–ï–¢–û–î–´ =====

// –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã
const debouncedSearch = debounce(async (query) => {
  await equipmentStore.setSearchQuery(query)
}, 300)

const debouncedSuggestions = debounce(async (query) => {
  if (!query || query.length < 2) {
    searchSuggestions.value = []
    return
  }
  
  searchLoading.value = true
  try {
    const suggestions = await equipmentStore.getSearchSuggestions(query)
    searchSuggestions.value = suggestions
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞:', error)
    searchSuggestions.value = []
  } finally {
    searchLoading.value = false
  }
}, 150)

const handleSearch = (query) => {
  searchQuery.value = query
  debouncedSearch(query)
  debouncedSuggestions(query)
}

const handleSearchSelect = (suggestion) => {
  searchQuery.value = suggestion.value
  debouncedSearch(suggestion.value)
  searchSuggestions.value = []
}

const handleSearchClear = () => {
  searchQuery.value = ''
  searchSuggestions.value = []
  debouncedSearch.cancel()
  debouncedSuggestions.cancel()
  equipmentStore.setSearchQuery('')
}

const handleCategoryChange = async (category) => {
  selectedCategory.value = category
  selectedSubcategory.value = ''
  await equipmentStore.setFilters({ type: category, subtype: '' })
}

const handleSubcategoryChange = async (subcategory) => {
  selectedSubcategory.value = subcategory
  await equipmentStore.setFilters({ 
    type: selectedCategory.value, 
    subtype: subcategory 
  })
}

const handleClearFilters = async () => {
  searchQuery.value = ''
  selectedCategory.value = ''
  selectedSubcategory.value = ''
  searchSuggestions.value = []
  debouncedSearch.cancel()
  debouncedSuggestions.cancel()
  await equipmentStore.setSearchQuery('')
  await equipmentStore.clearFilters()
}

// –¢–∞–±–ª–∏—Ü–∞
const handleSort = async (sortEvent) => {
  console.log('üîÑ [Create] Sort event received:', sortEvent)
  // –ù–ï –ø–µ—Ä–µ–¥–∞–µ–º direction, –ø–æ–∑–≤–æ–ª—è–µ–º store —Å–∞–º–æ–º—É —É–ø—Ä–∞–≤–ª—è—Ç—å –ª–æ–≥–∏–∫–æ–π –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
  await equipmentStore.setSorting(sortEvent.column)
}

const handlePageChange = async (page) => {
  await equipmentStore.setPage(page)
}

const handleItemsPerPageChange = async (items) => {
  await equipmentStore.setItemsPerPage(items)
}

// –í—ã–±–æ—Ä –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
const handleSelectionChange = (newSelectedIds) => {
  console.log('üîÑ [Selection] –ù–æ–≤—ã–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ IDs:', newSelectedIds)
  console.log('üîÑ [Selection] –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', isEditMode.value)
  
  // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
  const validIds = newSelectedIds.filter(id => canAddEquipment(id))
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –±—ã–ª–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
  if (validIds.length !== newSelectedIds.length) {
    const blockedCount = newSelectedIds.length - validIds.length
    notificationSystem.value?.warning(
      `${blockedCount} –µ–¥–∏–Ω–∏—Ü –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–æ - —É–∂–µ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è`,
      {
        title: '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ',
        duration: 4000
      }
    )
  }
  
  // –ü–†–û–í–ï–†–Ø–ï–ú –ø–æ–ø—ã—Ç–∫—É –æ—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —Å–ø–∏—Å–æ–∫
  if (validIds.length === 0 && (formData.value.equipment_ids?.length > 0 || selectedEquipmentIds.value.length > 0)) {
    console.log('‚ö†Ô∏è [Selection] –ü–æ–ø—ã—Ç–∫–∞ –æ—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —Å–ø–∏—Å–æ–∫')
    console.log('‚ö†Ô∏è [Selection] validIds:', validIds.length)
    console.log('‚ö†Ô∏è [Selection] formData.equipment_ids:', formData.value.equipment_ids?.length)
    console.log('‚ö†Ô∏è [Selection] selectedEquipmentIds:', selectedEquipmentIds.value.length)
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–æ –ü–û–ó–í–û–õ–Ø–ï–ú –æ—á–∏—Å—Ç–∫—É
    notificationSystem.value?.warning('–í–Ω–∏–º–∞–Ω–∏–µ: —Å–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –ø—É—Å—Ç—ã–º. –í—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.', {
      title: '–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç',
      duration: 3000
    })
    
    // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –ù–ï –¥–µ–ª–∞–µ–º return
    // –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –æ–±–Ω–æ–≤–∏—Ç—å formData.equipment_ids = [] –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É
    console.log('‚úÖ [Selection] –†–∞–∑—Ä–µ—à–∞–µ–º –æ—á–∏—Å—Ç–∫—É - –∫–Ω–æ–ø–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏')
  }
  
  // –í –û–ë–û–ò–• —Ä–µ–∂–∏–º–∞—Ö —Ç–µ–ø–µ—Ä—å —Ç–æ—á–Ω–æ –æ—Ç—Ä–∞–∂–∞–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  console.log('üìù [Selection] –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±–æ—Ä –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è')
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
  const currentSelectedIds = new Set(selectedEquipmentIds.value)
  const updatedSelectedIds = new Set(validIds)
  
  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∫—ç—à
  validIds.forEach(id => {
    if (!currentSelectedIds.has(id)) {
      const equipment = equipments.value.find(eq => eq.id === id)
      if (equipment && !selectedEquipmentCache.value.has(id)) {
        selectedEquipmentCache.value.set(id, equipment)
        console.log('üìù [Selection] –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫—ç—à:', equipment.brand, equipment.model)
      }
    }
  })
  
  // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –∫—ç—à–∞, –∫–æ—Ç–æ—Ä—ã–µ –±–æ–ª—å—à–µ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã
  selectedEquipmentIds.value.forEach(id => {
    if (!updatedSelectedIds.has(id)) {
      selectedEquipmentCache.value.delete(id)
      console.log('üìù [Selection] –£–¥–∞–ª–µ–Ω–æ –∏–∑ –∫—ç—à–∞:', id)
    }
  })
  
  selectedEquipmentIds.value = validIds
  updateSelectedEquipment(validIds)
  console.log('üìù [Selection] –§–∏–Ω–∞–ª—å–Ω—ã–µ IDs:', validIds.length)
  console.log('üìù [Selection] –†–∞–∑–º–µ—Ä –∫—ç—à–∞:', selectedEquipmentCache.value.size)
  console.log('üîç [Selection] canCreateList –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:', canCreateList.value)
}

const handleRemoveEquipment = (equipmentId) => {
  console.log('üóëÔ∏è [Remove] –£–¥–∞–ª—è–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:', equipmentId)
  console.log('üóëÔ∏è [Remove] –¢–µ–∫—É—â–∏–µ IDs:', selectedEquipmentIds.value)
  
  const newIds = selectedEquipmentIds.value.filter(id => id !== equipmentId)
  console.log('üóëÔ∏è [Remove] IDs –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:', newIds)
  
  // –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê - –Ω–µ —É–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –µ–¥–∏–Ω–∏—Ü—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
  if (newIds.length === 0) {
    console.log('‚ùå [Remove] –ë–õ–û–ö–ò–†–û–í–ê–ù–û: –ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –µ–¥–∏–Ω–∏—Ü—É')
    notificationSystem.value?.error('–°–ø–∏—Å–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –û—Å—Ç–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –µ–¥–∏–Ω–∏—Ü—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.', {
      title: '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏',
      duration: 4000
    })
    return // –ù–ï —É–¥–∞–ª—è–µ–º, –µ—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –µ–¥–∏–Ω–∏—Ü–∞
  }
  
  // –ê–¢–û–ú–ê–†–ù–û–ï –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ - —Å–Ω–∞—á–∞–ª–∞ selectedEquipmentIds, –ø–æ—Ç–æ–º formData
  selectedEquipmentIds.value = newIds
  updateSelectedEquipment(newIds)
  
  // –£–¥–∞–ª—è–µ–º –∏–∑ –∫—ç—à–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
  selectedEquipmentCache.value.delete(equipmentId)
  console.log('üóëÔ∏è [Remove] –£–¥–∞–ª–µ–Ω–æ –∏–∑ –∫—ç—à–∞. –†–∞–∑–º–µ—Ä –∫—ç—à–∞:', selectedEquipmentCache.value.size)
  
  console.log('‚úÖ [Remove] –£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ. –û—Å—Ç–∞–ª–æ—Å—å:', newIds.length)
  console.log('üîç [Remove] canCreateList –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è:', canCreateList.value)
}

const handleClearSelection = () => {
  console.log('üßπ [Clear] –ü–æ–ø—ã—Ç–∫–∞ –æ—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è')
  
  // –í —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫
  if (isEditMode.value && selectedEquipmentIds.value.length > 0) {
    notificationSystem.value?.error('–°–ø–∏—Å–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –û—Å—Ç–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –µ–¥–∏–Ω–∏—Ü—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.', {
      title: '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏',
      duration: 4000
    })
    return // –ù–ï –æ—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  }
  
  console.log('üßπ [Clear] –û—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è')
  // –ü—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –≤—ã–∑–æ–≤–∞ handleSelectionChange
  selectedEquipmentIds.value = []
  updateSelectedEquipment([])
  
  // –û—á–∏—â–∞–µ–º –∫—ç—à –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
  selectedEquipmentCache.value.clear()
  console.log('üßπ [Clear] –ö—ç—à –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –æ—á–∏—â–µ–Ω')
}

const handleExportList = () => {
  console.log('–≠–∫—Å–ø–æ—Ä—Ç —Å–ø–∏—Å–∫–∞')
}

// –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
const handleEventChange = async (eventId) => {
  const eventName = getEventName(eventId)
  updateLinkedData({ eventId, eventName })
  
  formData.value.mount_point_id = null
  
  if (eventId) {
    await loadMountPoints(eventId)
  } else {
    clearMountPoints()
  }
  
  // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
  if (eventId && formData.value.type === 'security') {
    console.log('üéØ [EventChange] –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:', eventId)
    // –í —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–¥–∞–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –µ–≥–æ –∏–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
    setEvent(eventId, isEditMode.value ? props.id : null)
  } else {
    console.log('üßπ [EventChange] –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã')
    clearConflicts()
  }
}

const handleMountPointChange = (mountPointId) => {
  const mountPointName = getMountPointName(mountPointId)
  updateLinkedData({ mountPointId, mountPointName })
}

const handleTypeChange = (newType) => {
  handleTypeChangeLogic(newType)
  
  // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞ –Ω–∞ security - –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
  if (newType === 'security' && formData.value.event_id) {
    console.log('üéØ [TypeChange] –¢–∏–ø –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ security, –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:', formData.value.event_id)
    // –í —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–¥–∞–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –µ–≥–æ –∏–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
    setEvent(formData.value.event_id, isEditMode.value ? props.id : null)
  } else if (newType !== 'security') {
    console.log('üßπ [TypeChange] –¢–∏–ø –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ –Ω–µ-security, –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã')
    clearConflicts()
  }
}

// –°–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è
const handleCreateList = async () => {
  console.log('üîÑ [handleCreateList] –ù–∞—á–∏–Ω–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é...')
  console.log('üîÑ [handleCreateList] –¢–µ–∫—É—â–∏–µ IDs –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', formData.value.equipment_ids)
  console.log('üîÑ [handleCreateList] –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', formData.value.equipment_ids?.length || 0)
  
  // –¢–†–û–ô–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê - –∞–±—Å–æ–ª—é—Ç–Ω–æ –∫—Ä–∏—Ç–∏—á–Ω–æ
  if (!formData.value.equipment_ids || formData.value.equipment_ids.length === 0) {
    console.log('‚ùå [handleCreateList] –ë–õ–û–ö–ò–†–û–í–ê–ù–û: –°–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø—É—Å—Ç–æ–π')
    notificationSystem.value?.error('–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –°–ø–∏—Å–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –µ–¥–∏–Ω–∏—Ü—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è', {
      title: '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏',
      duration: 6000
    })
    return
  }
  
  if (!validateForm()) {
    console.log('‚ùå [handleCreateList] –ë–õ–û–ö–ò–†–û–í–ê–ù–û: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞')
    notificationSystem.value?.error('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', {
      title: '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏',
      duration: 4000
    })
    return
  }
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ equipment_ids –∫–∞–∫–∏–º-—Ç–æ –æ–±—Ä–∞–∑–æ–º —Å—Ç–∞–ª –ø—É—Å—Ç—ã–º
  if (!formData.value.equipment_ids || formData.value.equipment_ids.length === 0) {
    console.log('‚ùå [handleCreateList] –ë–õ–û–ö–ò–†–û–í–ê–ù–û: –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø—É—Å—Ç–æ–π')
    notificationSystem.value?.error('–ü–û–í–¢–û–†–ù–ê–Ø –û–®–ò–ë–ö–ê: –°–ø–∏—Å–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –µ–¥–∏–Ω–∏—Ü—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è', {
      title: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏',
      duration: 6000
    })
    return
  }
  
  console.log('‚úÖ [handleCreateList] –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...')
  
  createLoading.value = true
  
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    if (!authStore.isAuthenticated || !authStore.user?.id) {
      throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω')
    }

    const listData = {
      name: formData.value.type === 'security' && !isEditMode.value ? autoGeneratedName.value : formData.value.name,
      description: formData.value.type === 'security' && !isEditMode.value ? autoGeneratedDescription.value : formData.value.description,
      type: formData.value.type,
      equipment_ids: formData.value.equipment_ids,
      event_id: formData.value.event_id,
      mount_point_id: formData.value.mount_point_id
    }
    
    // –í —Ä–µ–∂–∏–º–µ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ
    if (!isEditMode.value) {
      listData.created_by = authStore.user.id
      listData.metadata = {
        created_by_name: authStore.user.name || authStore.user.email || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
        created_by_role: authStore.role,
        version: '1.0'
      }
    }
    
    let result
    if (isEditMode.value) {
      // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å–ø–∏—Å–æ–∫
      console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ ID:', props.id)
      result = await updateEquipmentList(props.id, listData)
    } else {
      // –†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å–ø–∏—Å–æ–∫
      console.log('‚ú® –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–ø–∏—Å–∫–∞')
      result = await createEquipmentList(listData)
    }
    
    notificationSystem.value?.success(
      isEditMode.value ? '–°–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!' : '–°–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', 
      {
        title: '–£—Å–ø–µ—Ö',
        duration: 4000
      }
    )
    
    router.push('/equipment/lists')
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞', isEditMode.value ? '–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è' : '—Å–æ–∑–¥–∞–Ω–∏—è', '—Å–ø–∏—Å–∫–∞:', error)
    
    let errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
    if (error.message) {
      errorMessage = error.message
    } else if (error.code) {
      errorMessage = `–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: ${error.code}`
    }
    
    notificationSystem.value?.error(
      `–ù–µ —É–¥–∞–ª–æ—Å—å ${isEditMode.value ? '–æ–±–Ω–æ–≤–∏—Ç—å' : '—Å–æ–∑–¥–∞—Ç—å'} —Å–ø–∏—Å–æ–∫: ${errorMessage}`, 
      {
        title: isEditMode.value ? '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è' : '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è',
        duration: 5000
      }
    )
  } finally {
    createLoading.value = false
  }
}

const handleResetForm = () => {
  resetForm()
  selectedEquipmentIds.value = []
  conflictInfo.value = {}
  searchQuery.value = ''
  selectedCategory.value = ''
  selectedSubcategory.value = ''
  searchSuggestions.value = []
  
  // –û—Ç–º–µ–Ω—è–µ–º –≤—Å–µ debounced —Ñ—É–Ω–∫—Ü–∏–∏
  debouncedSearch.cancel()
  debouncedSuggestions.cancel()
  
  clearMountPoints()
  equipmentStore.setPage(1)
  
  notificationSystem.value?.info('–í—Å–µ –ø–æ–ª—è –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é', {
    title: '–§–æ—Ä–º–∞ —Å–±—Ä–æ—à–µ–Ω–∞'
  })
}

// –ù–∞–≤–∏–≥–∞—Ü–∏—è
const handleBreadcrumbClick = (data) => {
  if (data.isSubmenu) {
    if (data.item.href) {
      router.push(data.item.href)
    }
    return
  }
  
  if (data.item.href && !data.item.disabled) {
    router.push(data.item.href)
  }
}

const handleBreadcrumbNavigate = (data) => {
  if (data.href) {
    router.push(data.href)
  }
}

const navigateBack = () => {
  router.push('/equipment/lists')
}

// ===== LIFECYCLE =====
onMounted(async () => {
  console.log('üèÅ [Page] –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –†–µ–∂–∏–º:', isEditMode.value ? '—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : '—Å–æ–∑–¥–∞–Ω–∏–µ')
  
  // –û—á–∏—â–∞–µ–º –∫—ç—à –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–ª—è —Å–≤–µ–∂–µ–≥–æ —Å—Ç–∞—Ä—Ç–∞
  selectedEquipmentCache.value.clear()
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º authStore –µ—Å–ª–∏ –æ–Ω –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
  if (!authStore.isAuthenticated && !authStore.session) {
    await authStore.init()
  }
  
  // –í —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∞ –ü–ï–†–í–´–ú –¥–µ–ª–æ–º
  if (isEditMode.value && props.id) {
    console.log('üìù [Page] –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫:', props.id)
    
    // –ü–µ—Ä–µ–¥–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π —Å–æ–±—ã—Ç–∏–π –∏ —Ç–æ—á–µ–∫ –º–æ–Ω—Ç–∞–∂–∞
    await loadListForEdit(props.id, {
      getEventName,
      getMountPointName, 
      loadMountPoints
    })
    
    // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ (–û–î–ù–û–†–ê–ó–û–í–û –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ)
    selectedEquipmentIds.value = [...(formData.value.equipment_ids || [])]
    console.log('üîÑ [Page] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã IDs –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', selectedEquipmentIds.value.length)
    console.log('üîç [Page] canCreateList –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏:', canCreateList.value)
    
    // –ö–†–ò–¢–ò–ß–ù–û: –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø–æ ID –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    if (selectedEquipmentIds.value.length > 0) {
      console.log('üîÑ [Page] –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è')
      try {
        const { getEquipmentByIds } = await import('@/features/equipment/api/equipment-external-data-api')
        const result = await getEquipmentByIds(selectedEquipmentIds.value)
        if (result.data && Array.isArray(result.data)) {
          // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫—ç—à –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
          result.data.forEach(equipment => {
            selectedEquipmentCache.value.set(equipment.id, equipment)
          })
          console.log('‚úÖ [Page] –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –≤ –∫—ç—à –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:', result.data.length, '–µ–¥–∏–Ω–∏—Ü')
          console.log('‚úÖ [Page] –†–∞–∑–º–µ—Ä –∫—ç—à–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', selectedEquipmentCache.value.size)
        }
      } catch (error) {
        console.error('‚ùå [Page] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error)
      }
    }
  }
  
  await Promise.all([
    equipmentStore.loadEquipments(),
    initializeListsData()
  ])
  
  if (eventsError.value) {
    notificationSystem.value?.error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è: ${eventsError.value}`, {
      title: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'
    })
  }
  
  console.log('üìã –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (refactored)')
})

// ===== CLEANUP =====
onBeforeUnmount(() => {
  console.log('üßπ [Page] –†–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - –æ—á–∏—â–∞–µ–º –∫—ç—à –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è')
  selectedEquipmentCache.value.clear()
})

// ===== WATCHERS =====
// –£–î–ê–õ–Ø–ï–ú –¶–ò–ö–õ–ò–ß–ï–°–ö–ò–ô WATCHER - –æ–Ω —Å–æ–∑–¥–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã!
// selectedEquipmentIds —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ handleSelectionChange/handleRemoveEquipment
// formData.equipment_ids –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ updateSelectedEquipment

// –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ —Ç–∏–ø–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
watch([() => formData.value.event_id, () => formData.value.type], ([newEventId, newType]) => {
  console.log('üîÑ [Watch] –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∏–ª–∏ —Ç–∏–ø –∏–∑–º–µ–Ω–∏–ª–∏—Å—å:', { eventId: newEventId, type: newType })
  
  if (newEventId && newType === 'security') {
    console.log('‚úÖ [Watch] –£—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã')
    // –í —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–¥–∞–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –µ–≥–æ –∏–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
    setEvent(newEventId, isEditMode.value ? props.id : null)
  } else {
    console.log('‚ùå [Watch] –£—Å–ª–æ–≤–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã')
    clearConflicts()
  }
}, { immediate: true })
</script>

<style scoped>
/* UI Kit v2 + Bento Grid –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */

@media (max-width: 767px) {
  .order-first {
    order: -1;
  }
  
  .md\:sticky {
    position: static !important;
  }
  
  .md\:z-10 {
    z-index: auto !important;
  }
  
  .space-y-4 > * + * {
    margin-top: 1rem;
  }
}

@media (min-width: 768px) {
  .md\:order-last {
    order: 1;
  }
  
  .md\:sticky {
    position: sticky;
    top: 1.5rem;
  }
  
  .md\:space-y-6 > * + * {
    margin-top: 1.5rem;
  }
}

.contain-layout {
  contain: layout style;
}


</style>