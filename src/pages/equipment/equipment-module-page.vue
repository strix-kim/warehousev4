<template>
  <div class="min-h-screen bg-accent">
    <!-- Header —Å Breadcrumbs -->
    <div class="bg-white border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 py-4">
        <BreadcrumbsV2 
          :items="breadcrumbs" 
          variant="minimal" 
          size="sm"
          @item-click="handleBreadcrumbClick"
          @navigate="handleBreadcrumbNavigate"
        />
        
        <div class="flex justify-between items-center mt-4">
          <div>
            <h1 class="text-3xl font-bold text-primary">–ú–æ–¥—É–ª—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h1>
            <p class="text-base text-secondary mt-2">
              –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º, —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content –≤ Bento Grid -->
    <div class="max-w-7xl mx-auto px-4 py-8">
      <BentoGrid columns="auto" gap="6">
        
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º -->
        <BentoCard 
          title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º" 
          size="2x2" 
          variant="primary"
          :interactive="true"
          @click="navigateToItems"
        >
          <div class="flex flex-col justify-between h-full">
            <div>
              <p class="text-accent/90 mb-4">
                –î–æ–±–∞–≤–ª–µ–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è. 
                –ü–æ–∏—Å–∫, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.
              </p>
              
              <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
              <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white/10 rounded-lg p-3 text-center">
                  <div class="text-2xl font-bold text-accent">{{ equipmentStats.total }}</div>
                  <div class="text-xs text-accent/70">–í—Å–µ–≥–æ –µ–¥–∏–Ω–∏—Ü</div>
                </div>
                <div class="bg-white/10 rounded-lg p-3 text-center">
                  <div class="text-2xl font-bold text-accent">{{ equipmentStats.categories }}</div>
                  <div class="text-xs text-accent/70">–ö–∞—Ç–µ–≥–æ—Ä–∏–π</div>
                </div>
              </div>
            </div>
            
            <div class="flex items-center justify-between">
              <span class="text-accent/80 text-sm">–ü–µ—Ä–µ–π—Ç–∏ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é</span>
              <IconV2 name="arrow-right" size="sm" color="current" />
            </div>
          </div>
        </BentoCard>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞: –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ -->
        <BentoCard 
          title="–°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤" 
          size="1x2" 
          variant="brand-red"
          :interactive="true"
          @click="navigateToCreateList"
        >
          <div class="flex flex-col justify-between h-full">
            <div>
              <p class="text-accent/90 mb-4">
                –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–ø–∏—Å–∫–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è: —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∏–ª–∏ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∫ —Ç–æ—á–∫–∞–º –º–æ–Ω—Ç–∞–∂–∞.
              </p>
              
              <div class="space-y-3">
                <div class="flex items-center gap-2">
                  <IconV2 name="list" size="xs" color="current" />
                  <span class="text-accent/80 text-sm">–°–≤–æ–±–æ–¥–Ω—ã–µ —Å–ø–∏—Å–∫–∏</span>
                </div>
                <div class="flex items-center gap-2">
                  <IconV2 name="link" size="xs" color="current" />
                  <span class="text-accent/80 text-sm">–ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Ç–æ—á–∫–∞–º –º–æ–Ω—Ç–∞–∂–∞</span>
                </div>
              </div>
            </div>
            
            <div class="flex items-center justify-between mt-4">
              <span class="text-accent/80 text-sm">–°–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫</span>
              <IconV2 name="plus" size="sm" color="current" />
            </div>
          </div>
        </BentoCard>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞: –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–æ–≤ -->
        <BentoCard 
          title="–°–ø–∏—Å–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è" 
          size="1x2" 
          variant="secondary"
          :interactive="true"
          @click="navigateToLists"
        >
          <div class="flex flex-col justify-between h-full">
            <div>
              <p class="text-accent/90 mb-4">
                –ü—Ä–æ—Å–º–æ—Ç—Ä, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Å–ø–∏—Å–∫–∞–º–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
              </p>
              
              <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–ø–∏—Å–∫–æ–≤ -->
              <div class="space-y-3">
                <div class="bg-white/10 rounded-lg p-3">
                  <div class="flex justify-between items-center">
                    <span class="text-accent/80 text-sm">–í—Å–µ–≥–æ —Å–ø–∏—Å–∫–æ–≤</span>
                    <span class="text-xl font-bold text-accent">{{ listsStats.total }}</span>
                  </div>
                </div>
                <div class="bg-white/10 rounded-lg p-3">
                  <div class="flex justify-between items-center">
                    <span class="text-accent/80 text-sm">–°–≤—è–∑–∞–Ω–Ω—ã—Ö</span>
                    <span class="text-xl font-bold text-accent">{{ listsStats.linked }}</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="flex items-center justify-between mt-4">
              <span class="text-accent/80 text-sm">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞–º–∏</span>
              <IconV2 name="list" size="sm" color="current" />
            </div>
          </div>
        </BentoCard>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞: –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <BentoCard 
          title="–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è" 
          size="2x1" 
          variant="minimal"
        >
          <div class="flex items-center justify-between gap-4">
            <ButtonV2 
              variant="primary" 
              size="sm"
              @click="navigateToItems"
            >
              <template #icon>
                <IconV2 name="plus" size="xs" />
              </template>
              –î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
            </ButtonV2>
            
            <ButtonV2 
              variant="secondary" 
              size="sm"
              @click="navigateToCreateList"
            >
              <template #icon>
                <IconV2 name="list-plus" size="xs" />
              </template>
              –°–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫
            </ButtonV2>
            
            <ButtonV2 
              variant="ghost" 
              size="sm"
              @click="navigateToLists"
            >
              <template #icon>
                <IconV2 name="search" size="xs" />
              </template>
              –ù–∞–π—Ç–∏ —Å–ø–∏—Å–æ–∫
            </ButtonV2>
          </div>
        </BentoCard>

      </BentoGrid>
    </div>

    <!-- Notification System -->
    <NotificationV2 ref="notificationSystem" position="top-right" />
  </div>
</template>

<script setup>
/**
 * Equipment Module Page - –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –º–æ–¥—É–ª—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
 * –°–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫ –æ—Å–Ω–æ–≤–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º –º–æ–¥—É–ª—è
 */

import { ref, computed, onMounted, watch } from 'vue'
import { useRouter } from 'vue-router'

// UI Kit v2
import { 
  BentoGrid, 
  BentoCard, 
  BreadcrumbsV2, 
  ButtonV2, 
  IconV2,
  NotificationV2 
} from '@/shared/ui-v2'

// Equipment module
import { useEquipmentStore, useEquipmentStats } from '@/features/equipment'

const router = useRouter()
const equipmentStore = useEquipmentStore()

// === COMPOSABLES ===
const { 
  stats,
  loading: statsLoading,
  error: statsError,
  equipmentStats,
  listsStats,
  loadStats,
  clearError
} = useEquipmentStats()

// Notification system
const notificationSystem = ref(null)

// === BREADCRUMBS ===
const breadcrumbs = [
  { label: '–ì–ª–∞–≤–Ω–∞—è', href: '/', icon: 'home' },
  { 
    label: '–ú–æ–¥—É–ª—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è', 
    disabled: true,
    submenu: [
      { label: 'üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º', href: '/equipment/items', icon: 'settings' },
      { label: 'üìã –°–ø–∏—Å–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è', href: '/equipment/lists', icon: 'list' },
      { label: '‚ûï –°–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫', href: '/equipment/lists/create', icon: 'plus' }
    ]
  }
]

// === –ù–ê–í–ò–ì–ê–¶–ò–Ø ===
const navigateToItems = () => {
  router.push('/equipment/items')
}

const navigateToCreateList = () => {
  router.push('/equipment/lists/create')
}

const navigateToLists = () => {
  router.push('/equipment/lists')
}

// === BREADCRUMBS –ù–ê–í–ò–ì–ê–¶–ò–Ø ===
const handleBreadcrumbClick = (data) => {
  console.log('üß≠ [Module] –ö–ª–∏–∫ –ø–æ breadcrumb:', data.item.label)
  
  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏ –ø–æ submenu
  if (data.isSubmenu) {
    console.log('üß≠ [Module] –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ submenu:', data.item.href)
    if (data.item.href) {
      router.push(data.item.href)
    }
    return
  }
  
  // –û–±—ã—á–Ω—ã–µ breadcrumbs
  if (data.item.href && !data.item.disabled) {
    router.push(data.item.href)
  }
}

const handleBreadcrumbNavigate = (data) => {
  console.log('üß≠ [Module] –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ breadcrumb:', data.href)
  if (data.href) {
    router.push(data.href)
  }
}

// === –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ===
const initializeModule = async () => {
  try {
    clearError() // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏
    await loadStats()
    
    console.log('‚úÖ [Module] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', {
      equipment: equipmentStats.value,
      lists: listsStats.value
    })
    
  } catch (error) {
    console.error('‚ùå [Module] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥—É–ª—è:', error)
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ NotificationV2
    notificationSystem.value?.add({
      type: 'error',
      title: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏',
      message: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–æ–¥—É–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.',
      duration: 5000
    })
  }
}

// === –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö ===
// –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—à–∏–±–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
watch(statsError, (newError) => {
  if (newError && notificationSystem.value) {
    notificationSystem.value.add({
      type: 'error',
      title: '–û—à–∏–±–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏',
      message: newError,
      duration: 5000
    })
  }
})

onMounted(() => {
  initializeModule()
})
</script>